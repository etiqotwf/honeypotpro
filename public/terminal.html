<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Terminal Logs</title>
<style>
  body {
    font-family: monospace;
    background: #1e1e1e;
    color: #c5c8c6;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #111;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  button {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    background: #444;
    color: #fff;
    cursor: pointer;
  }
  button:hover {
    background: #666;
  }
  #logContainer {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #1e1e1e;
    white-space: pre-wrap;
  }
  .normal { color: #c5c8c6; }
  .malware { color: #ff5555; font-weight: bold; }
  .scan { color: #ffb86c; }
  .sql { color: #f1fa8c; }
  .xss { color: #8be9fd; }
  .brute { color: #bd93f9; }
</style>
</head>
<body>
<header>
  <button id="startBtn">‚ñ∂ Start</button>
  <button id="stopBtn">‚è∏ Stop</button>
  <button id="clearBtn">üóë Clear</button>
  <button id="downloadBtn">‚¨á Download CSV</button>
  <button id="copyBtn">üìã Copy</button>
</header>
<div id="logContainer"></div>

<script>
const logContainer = document.getElementById('logContainer');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');
const copyBtn = document.getElementById('copyBtn');

let eventSource = null;
let running = false;

function getClassForLine(line) {
  if (/malware detected/i.test(line)) return 'malware';
  if (/scan attempt/i.test(line)) return 'scan';
  if (/sql injection attempt/i.test(line)) return 'sql';
  if (/xss attempt/i.test(line)) return 'xss';
  if (/brute force attempt/i.test(line)) return 'brute';
  return 'normal';
}

const startSSE = () => {
  if (running) return;
  eventSource = new EventSource('/events');
  running = true;

  eventSource.addEventListener('initial', e => {
    const lines = JSON.parse(e.data);
    logContainer.innerHTML = '';
    lines.forEach(line => appendLine(line));
    logContainer.scrollTop = logContainer.scrollHeight;
  });

  eventSource.addEventListener('line', e => {
    const line = JSON.parse(e.data);
    appendLine(line);
    logContainer.scrollTop = logContainer.scrollHeight;
  });

  eventSource.onerror = () => {
    console.warn('SSE connection lost, trying to reconnect...');
    eventSource.close();
    running = false;
    setTimeout(startSSE, 2000);
  };
};

const appendLine = (line) => {
  const div = document.createElement('div');
  div.textContent = line;
  div.className = getClassForLine(line);
  logContainer.appendChild(div);
};

const stopSSE = () => {
  if (eventSource) {
    eventSource.close();
    running = false;
  }
};

const clearLog = () => {
  logContainer.textContent = '';
};

const downloadCSV = () => {
  window.location.href = '/download/csv';
};

const copyLog = () => {
  const text = Array.from(logContainer.children).map(d => d.textContent).join('\n');
  navigator.clipboard.writeText(text)
    .then(() => alert('‚úÖ Logs copied to clipboard'))
    .catch(err => alert('‚ùå Failed to copy logs: ' + err));
};

startBtn.addEventListener('click', startSSE);
stopBtn.addEventListener('click', stopSSE);
clearBtn.addEventListener('click', clearLog);
downloadBtn.addEventListener('click', downloadCSV);
copyBtn.addEventListener('click', copyLog);

// Start automatically
startSSE();
</script>
</body>
</html>
