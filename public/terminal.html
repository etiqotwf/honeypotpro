<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>🧠 AI Honeypot Terminal</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
  :root { --accent: #00ffcc; --bg: #000; --muted: #00ffaa22; }
  *{box-sizing:border-box}
  body {
    margin: 0;
    font-family: 'Share Tech Mono', monospace;
    background: radial-gradient(circle at top left, #050505 0%, #000 70%);
    color: #00ffcc;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  header {
    background: rgba(0,255,200,0.06);
    border-bottom: 1px solid #00ffcc22;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  h1 { font-size:1.2rem; margin:0; color:#00ffee; }
  #status { font-size:0.9rem; color:#aaffff; display:flex; align-items:center; gap:8px; }
  .status-dot { width:10px;height:10px;border-radius:50%;background:#ff4444;box-shadow:0 0 8px #ff4444; animation:pulse 1.5s infinite; }
  @keyframes pulse {0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.3)}}
  #controls { display:flex; gap:8px; align-items:center; }
  button {
    background: rgba(0,255,170,0.07);
    border: 1px solid rgba(0,255,170,0.18);
    color: var(--accent);
    padding: 8px 12px;
    border-radius:6px;
    cursor:pointer;
  }
  button:hover { box-shadow:0 0 8px rgba(0,255,170,0.06); transform:translateY(-1px); }
  #startAttack { background:#00aa66; border-color:#008844; color:#fff; }
  #logContainer { flex:1; overflow:auto; padding:14px; color:#d1fff5; text-shadow:0 0 5px #00ffee55; }
  .line { margin:4px 0; white-space:pre-wrap; font-size:0.95rem; }
  .attack { color:#ff8888; font-weight:600; }
  .system { color:#66ccff; }
  footer { background: rgba(0,255,200,0.03); text-align:center; padding:6px; font-size:0.86rem; color:#00ffee; }
  #infoBar { display:flex; gap:10px; align-items:center; color:#cffff0; }
  #ngrokUrl { font-size:0.85rem; color:#ffdca3; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <h1>🧠 AI Honeypot Command Center</h1>
    <div id="infoBar">
      <div id="status"><span class="status-dot" id="dot"></span><span id="statusText">Disconnected</span></div>
      <div id="ngrokUrl">ngrok: <span id="ngrokVal">waiting...</span></div>
    </div>
  </div>

  <div id="controls">
    <button id="startBtn">▶ Start SSE</button>
    <button id="stopBtn">⏸ Stop SSE</button>
    <button id="clearBtn">🗑 Clear</button>
    <button id="copyBtn">📋 Copy</button>
    <!-- زر فتح ngrok المخصص -->
    <button id="startAttack">🚀 فتح ngrok & بدء الهجوم</button>
  </div>
</header>

<div id="logContainer" aria-live="polite"></div>

<footer>💻 Honeypot AI Terminal — Monitoring cyber threats in real-time</footer>

<script>
const logContainer = document.getElementById('logContainer');
const statusDot = document.getElementById('dot');
const statusText = document.getElementById('statusText');
const ngrokVal = document.getElementById('ngrokVal');

let eventSource = null;
let running = false;
let attackStarted = false;

// Append lines to log
function appendLine(text, cls='line') {
  const d = document.createElement('div');
  d.className = cls;
  d.textContent = text;
  logContainer.appendChild(d);
  logContainer.scrollTop = logContainer.scrollHeight;
}

// SSE handlers
function updateStatus(connected) {
  if (connected) {
    statusDot.style.background = '#00ff55';
    statusDot.style.boxShadow = '0 0 10px #00ff55';
    statusText.textContent = 'Connected';
  } else {
    statusDot.style.background = '#ff4444';
    statusDot.style.boxShadow = '0 0 8px #ff4444';
    statusText.textContent = 'Disconnected';
  }
}

function startSSE() {
  if (running) return;
  eventSource = new EventSource('/events');
  running = true;
  updateStatus(true);
  appendLine('[SYSTEM] Connection established.');
  eventSource.addEventListener('line', e => appendLine(JSON.parse(e.data)));
  eventSource.onerror = () => {
    appendLine('[WARN] Connection lost... attempting reconnect');
    updateStatus(false);
    running = false;
    setTimeout(startSSE, 2000);
  };
}

function stopSSE() {
  if (eventSource) eventSource.close();
  running = false;
  updateStatus(false);
  appendLine('[SYSTEM] Stream stopped.');
}

// Buttons
document.getElementById('startBtn').onclick = startSSE;
document.getElementById('stopBtn').onclick = stopSSE;
document.getElementById('clearBtn').onclick = () => { logContainer.innerHTML = ''; };
document.getElementById('copyBtn').onclick = async () => {
  const text = Array.from(logContainer.children).map(el => el.textContent).join('\n');
  await navigator.clipboard.writeText(text);
  alert('✅ Logs copied to clipboard');
};

// زر فتح ngrok — ينادي السيرفر مرة واحدة فقط
document.getElementById('startAttack').addEventListener('click', async function() {
  if (attackStarted) return alert('⚠️ تم بدء العملية سابقًا');
  attackStarted = true;
  this.disabled = true;
  this.textContent = '⌛ جاري الفتح...';

  try {
    const res = await fetch('/api/open-ngrok', { method: 'POST' });
    const data = await res.json();
    if (!res.ok) {
      appendLine('[ERROR] فشل فتح ngrok: ' + (data.message || 'Unknown'), 'line system');
      alert('❌ فشل فتح ngrok: ' + (data.message || 'Unknown'));
      this.disabled = false;
      this.textContent = '🚀 فتح ngrok & بدء الهجوم';
      attackStarted = false;
      return;
    }
    appendLine('[SYSTEM] ngrok opened: ' + data.url, 'line system');
    ngrokVal.textContent = data.url;
    this.textContent = '✅ ngrok مفتوح';
    alert('✅ ngrok تم فتحه — راجع المتصفح المخصص (Chrome)');
  } catch (err) {
    appendLine('[ERROR] خطأ في الاتصال بالسيرفر: ' + err.message, 'line');
    alert('⚠️ خطأ في الاتصال بالسيرفر: ' + err.message);
    this.disabled = false;
    this.textContent = '🚀 فتح ngrok & بدء الهجوم';
    attackStarted = false;
  }
});

// فتح وضع ملء الشاشة عند النقر (اختياري)
document.body.addEventListener('click', async () => {
  if (!document.fullscreenElement) {
    try { await document.documentElement.requestFullscreen(); } catch(e) { /* ignore */ }
  }
});

// شغّل SSE تلقائيًا
startSSE();

// احصل على ngrok URL الموجود في serverUrl.json إن وُجد لعرضه مبكرًا
(async function fetchNgrokUrl() {
  try {
    const res = await fetch('/ngrok-url');
    if (res.ok) {
      const j = await res.json();
      if (j.serverUrl) ngrokVal.textContent = j.serverUrl;
    } else {
      // قد لا يكون جاهزًا بعد
      ngrokVal.textContent = 'waiting...';
    }
  } catch (e) {
    ngrokVal.textContent = 'waiting...';
  }
})();
</script>
</body>
</html>
